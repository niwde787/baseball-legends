<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baseball Legends: Rivalry Edition (PR vs AL)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-100 */
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .draggable {
            cursor: move;
        }
        .dragging {
            opacity: 0.5;
            background: #374151; /* bg-gray-700 */
        }
        .drop-zone {
            border: 2px dashed #4b5563; /* border-gray-600 */
            min-height: 50px;
        }
        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(30, 255, 255, 0.2);
        }
        .stadium-card.selected {
            border-color: #2dd4bf; /* teal-400 */
            box-shadow: 0 0 15px rgba(45, 212, 191, 0.5);
        }
    </style>
</head>
<body class="antialiased">

    <!-- App Container -->
    <div id="app" class="container mx-auto p-4 max-w-7xl">

        <!-- Team PR Builder Screen -->
        <section id="team-1-builder-screen" class="screen active">
            <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-4xl font-bold text-teal-400">Puerto Rico</h2>
                    <button id="randomize-team-1-btn" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-transform hover:scale-105 uppercase text-sm">RANDOMIZE TEAM</button>
                </div>
                <div id="team-1-builder" class="team-builder"></div>
                <div class="text-center mt-8">
                    <button id="to-team-2-builder-btn" class="bg-teal-500 text-gray-900 font-bold text-2xl py-3 px-12 rounded-lg shadow-lg transition-transform hover:scale-105 disabled:bg-gray-600 disabled:cursor-not-allowed uppercase" disabled>Alabama</button>
                </div>
            </div>
        </section>

        <!-- Team AL Builder Screen -->
        <section id="team-2-builder-screen" class="screen">
            <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-4xl mx-auto">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-4xl font-bold text-teal-400">Alabama</h2>
                    <button id="randomize-team-2-btn" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-transform hover:scale-105 uppercase text-sm">RANDOMIZE TEAM</button>
                </div>
                <div id="team-2-builder" class="team-builder"></div>
                <div class="text-center mt-8">
                    <button id="to-stadium-select-btn" class="bg-teal-500 text-gray-900 font-bold text-2xl py-3 px-12 rounded-lg shadow-lg transition-transform hover:scale-105 disabled:bg-gray-600 disabled:cursor-not-allowed uppercase" disabled>SELECT STADIUM</button>
                </div>
            </div>
        </section>

        <!-- Stadium Selector Screen -->
        <section id="stadium-selector-screen" class="screen">
            <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-6xl mx-auto">
                <h2 class="text-4xl font-bold text-center mb-6 text-teal-400">SELECT A STADIUM</h2>
                <div id="stadium-list" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
            </div>
            <div class="text-center mt-8">
                 <button id="to-game-btn" class="bg-teal-500 text-gray-900 font-bold text-2xl py-3 px-12 rounded-lg shadow-lg transition-transform hover:scale-105 disabled:bg-gray-600 disabled:cursor-not-allowed uppercase" disabled>PLAY BALL!</button>
            </div>
        </section>

        <!-- Game Simulation Screen -->
        <section id="game-simulation-screen" class="screen">
            <div class="bg-gray-800 p-4 rounded-lg shadow-xl">
                <div id="scoreboard" class="text-center mb-4"></div>
                <div id="game-inning-box-score" class="mb-4 overflow-x-auto hidden"></div>
                <div id="play-by-play" class="h-96 overflow-y-auto bg-gray-900 p-4 rounded font-mono border border-gray-700"></div>
            </div>
             <div id="game-summary" class="bg-gray-800 p-4 rounded-lg shadow-xl mt-4 hidden"></div>
             <div class="text-center mt-4">
                <button id="to-recap-btn" class="bg-teal-500 text-gray-900 font-bold text-xl py-2 px-8 rounded-lg shadow-lg hidden uppercase">VIEW FULL RECAP</button>
            </div>
        </section>

        <!-- Recap Screen -->
        <section id="recap-screen" class="screen">
            <h2 class="text-5xl font-bold text-center mb-6 text-teal-400">GAME RECAP</h2>
            <div id="mvp-section" class="text-center mb-6 bg-gray-800 p-4 rounded-lg shadow-xl"></div>
            <div id="inning-box-score" class="bg-gray-800 p-4 rounded-lg shadow-xl overflow-x-auto mb-6"></div>
            <div id="box-score" class="bg-gray-800 p-4 rounded-lg shadow-xl overflow-x-auto"></div>
            <div class="text-center mt-8 flex justify-center gap-4">
                <button id="rematch-btn" class="bg-teal-500 text-gray-900 font-bold text-2xl py-3 px-12 rounded-lg shadow-lg transition-transform hover:scale-105 uppercase">REMATCH</button>
                <button id="to-home-btn" class="bg-teal-500 text-gray-900 font-bold text-2xl py-3 px-12 rounded-lg shadow-lg transition-transform hover:scale-105 uppercase">NEW TEAMS</button>
            </div>
        </section>

    </div>

    <!-- Player Selection Modal -->
    <div id="player-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700">
                <h3 id="modal-title" class="text-2xl font-bold text-teal-400">Select Player</h3>
                <input type="text" id="player-search" class="w-full bg-gray-700 p-2 rounded mt-2" placeholder="Search by name...">
                <div id="era-filter" class="flex justify-center gap-4 mt-2"></div>
            </div>
            <div id="modal-player-list" class="p-4 overflow-y-auto"></div>
            <div class="p-4 border-t border-gray-700 text-right">
                <button id="modal-close-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg uppercase">CLOSE</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- DATA ---
        // Player database with birthplace property for rivalry mode
        const players = [
            // TEAM PUERTO RICO
            { id: 301, name: "Roberto Clemente", birthplace: "PR", positions: ["OF"], era: "Hall of Famer", eraTag: '70s', speed: 8, defense: 10, stats: { avg: .317, hr: 240, rbi: 1305, bb: 621, so: 1230, ab: 9454 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=RC" },
            { id: 302, name: "Ivan Rodriguez", birthplace: "PR", positions: ["C"], era: "Hall of Famer", eraTag: '90s', speed: 6, defense: 10, stats: { avg: .296, hr: 311, rbi: 1332, bb: 513, so: 1474, ab: 9592 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=IR" },
            { id: 303, name: "Roberto Alomar", birthplace: "PR", positions: ["2B"], era: "Hall of Famer", eraTag: '90s', speed: 8, defense: 10, stats: { avg: .300, hr: 210, rbi: 1134, bb: 1032, so: 1140, ab: 9073 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=RA" },
            { id: 304, name: "Orlando Cepeda", birthplace: "PR", positions: ["1B"], era: "Hall of Famer", eraTag: '70s', speed: 4, defense: 4, stats: { avg: .297, hr: 379, rbi: 1365, bb: 588, so: 1147, ab: 7927 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=OC" },
            { id: 305, name: "Carlos Beltran", birthplace: "PR", positions: ["OF"], era: "Legend", eraTag: 'modern', speed: 7, defense: 8, stats: { avg: .279, hr: 435, rbi: 1587, bb: 1084, so: 1772, ab: 9768 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=CB" },
            { id: 306, name: "Carlos Delgado", birthplace: "PR", positions: ["1B"], era: "Legend", eraTag: '90s', speed: 3, defense: 4, stats: { avg: .280, hr: 473, rbi: 1512, bb: 1109, so: 1745, ab: 7283 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=CD" },
            { id: 307, name: "Yadier Molina", birthplace: "PR", positions: ["C"], era: "Legend", eraTag: 'modern', speed: 3, defense: 10, stats: { avg: .277, hr: 176, rbi: 1022, bb: 618, so: 998, ab: 7824 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=YM" },
            { id: 308, name: "Francisco Lindor", birthplace: "PR", positions: ["SS"], era: "Active", eraTag: 'modern', speed: 8, defense: 9, stats: { avg: .274, hr: 215, rbi: 694, bb: 450, so: 950, ab: 4800 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=FL" },
            { id: 309, name: "Carlos Correa", birthplace: "PR", positions: ["SS"], era: "Active", eraTag: 'modern', speed: 5, defense: 8, stats: { avg: .272, hr: 172, rbi: 630, bb: 420, so: 900, ab: 3800 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=CC" },
            { id: 310, name: "Javier Baez", birthplace: "PR", positions: ["SS", "2B"], era: "Active", eraTag: 'modern', speed: 8, defense: 9, stats: { avg: .259, hr: 177, rbi: 560, bb: 200, so: 1200, ab: 4200 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JB" },
            { id: 311, name: "Bernie Williams", birthplace: "PR", positions: ["OF"], era: "Legend", eraTag: '90s', speed: 7, defense: 8, stats: { avg: .297, hr: 287, rbi: 1257, bb: 1069, so: 1169, ab: 7869 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=BW" },
            { id: 312, name: "Juan Gonzalez", birthplace: "PR", positions: ["OF"], era: "Legend", eraTag: '90s', speed: 4, defense: 5, stats: { avg: .295, hr: 434, rbi: 1404, bb: 549, so: 1279, ab: 6555 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JG" },
            { id: 313, name: "Edgar Martinez", birthplace: "PR", positions: ["DH", "3B"], era: "Hall of Famer", eraTag: '90s', speed: 3, defense: 4, stats: { avg: .312, hr: 309, rbi: 1261, bb: 1283, so: 1202, ab: 7213 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=EM" },
            { id: 314, name: "Jorge Posada", birthplace: "PR", positions: ["C"], era: "Legend", eraTag: '90s', speed: 3, defense: 6, stats: { avg: .273, hr: 275, rbi: 1065, bb: 936, so: 1453, ab: 6092 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JP" },
            { id: 315, name: "Vic Power", birthplace: "PR", positions: ["1B"], era: "Legend", eraTag: '50s', speed: 6, defense: 9, stats: { avg: .284, hr: 126, rbi: 658, bb: 335, so: 360, ab: 5562 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=VP" },
            { id: 316, name: "Jose Berrios", birthplace: "PR", positions: ["P"], era: "Active", eraTag: 'modern', stats: { era: 4.10, so: 1250, wins: 88, ip: 1300, bb: 380, ha: 1250 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JB" },
            { id: 317, name: "Edwin Diaz", birthplace: "PR", positions: ["P"], era: "Active", eraTag: 'modern', stats: { era: 2.93, so: 670, saves: 205, ip: 400, bb: 130, ha: 280 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=ED" },
            { id: 318, name: "Sandy Alomar Jr.", birthplace: "PR", positions: ["C"], era: "Legend", eraTag: '90s', speed: 4, defense: 8, stats: { avg: .273, hr: 112, rbi: 588, bb: 324, so: 701, ab: 4781 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=SAJ" },
            { id: 319, name: "Benito Santiago", birthplace: "PR", positions: ["C"], era: "Legend", eraTag: '90s', speed: 6, defense: 9, stats: { avg: .263, hr: 217, rbi: 920, bb: 434, so: 1137, ab: 7575 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=BS" },
            { id: 320, name: "Ruben Sierra", birthplace: "PR", positions: ["OF"], era: "Legend", eraTag: '90s', speed: 6, defense: 5, stats: { avg: .268, hr: 306, rbi: 1322, bb: 757, so: 1493, ab: 8225 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=RS" },
            { id: 321, name: "Willie Hernandez", birthplace: "PR", positions: ["P"], era: "Legend", eraTag: '80s', stats: { era: 3.38, so: 778, saves: 147, ip: 1064, bb: 389, ha: 975 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=WH" },
            { id: 322, name: "John Candelaria", birthplace: "PR", positions: ["P"], era: "Legend", eraTag: '80s', stats: { era: 3.33, so: 1673, wins: 177, ip: 2525, bb: 978, ha: 2364 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JC" },
            { id: 323, name: "Eddie Rosario", birthplace: "PR", positions: ["OF"], era: "Active", eraTag: 'modern', speed: 6, defense: 6, stats: { avg: .268, hr: 180, rbi: 580, bb: 250, so: 800, ab: 3800 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=ER" },
            { id: 324, name: "Enrique Hernandez", birthplace: "PR", positions: ["OF", "2B", "SS"], era: "Active", eraTag: 'modern', speed: 6, defense: 8, stats: { avg: .239, hr: 110, rbi: 380, bb: 300, so: 850, ab: 3200 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=EH" },
            { id: 325, name: "Martin Maldonado", birthplace: "PR", positions: ["C"], era: "Active", eraTag: 'modern', speed: 2, defense: 9, stats: { avg: .207, hr: 100, rbi: 320, bb: 350, so: 1100, ab: 3200 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=MM" },
            { id: 507, name: "Javier Vazquez", birthplace: "PR", positions: ["P"], era: "Legend", eraTag: 'modern', stats: { era: 4.22, so: 2536, wins: 165, ip: 2840, bb: 856, ha: 2700 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JV" },
            { id: 508, name: "Juan Pizarro", birthplace: "PR", positions: ["P"], era: "Legend", eraTag: '70s', stats: { era: 3.43, so: 1522, wins: 131, ip: 2049, bb: 843, ha: 1800 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JP" },
            { id: 509, name: "Jose DeLeon", birthplace: "PR", positions: ["P"], era: "Legend", eraTag: '90s', stats: { era: 3.76, so: 1594, wins: 86, ip: 1911, bb: 934, ha: 1650 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JD" },
            { id: 510, name: "Ruben Gomez", birthplace: "PR", positions: ["P"], era: "Legend", eraTag: '50s', stats: { era: 4.09, so: 679, wins: 76, ip: 1373, bb: 513, ha: 1380 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=RG" },
            { id: 511, name: "Fernando Cabrera", birthplace: "PR", positions: ["P"], era: "Legend", eraTag: 'modern', stats: { era: 4.15, so: 187, saves: 1, ip: 182, bb: 93, ha: 170 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=FC" },
            { id: 512, name: "Jorge Lopez", birthplace: "PR", positions: ["P"], era: "Active", eraTag: 'modern', stats: { era: 4.70, so: 417, saves: 25, ip: 471, bb: 200, ha: 480 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JL" },
            { id: 513, name: "Alex Claudio", birthplace: "PR", positions: ["P"], era: "Active", eraTag: 'modern', stats: { era: 3.60, so: 252, saves: 14, ip: 362, bb: 102, ha: 370 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=AC" },
            { id: 514, name: "Giovanni Soto", birthplace: "PR", positions: ["P"], era: "Legend", eraTag: 'modern', stats: { era: 5.19, so: 6, wins: 0, ip: 8.2, bb: 5, ha: 10 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=GS" },
            { id: 515, name: "Wilfredo Boscan", birthplace: "PR", positions: ["P"], era: "Legend", eraTag: 'modern', stats: { era: 6.39, so: 15, wins: 1, ip: 31, bb: 15, ha: 40 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=WB" },
            { id: 516, name: "Mike Lowell", birthplace: "PR", positions: ["3B"], era: "Legend", eraTag: 'modern', speed: 3, defense: 8, stats: { avg: .279, hr: 223, rbi: 952, bb: 586, so: 793, ab: 6081 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=ML" },

            // TEAM ALABAMA
            { id: 401, name: "Hank Aaron", birthplace: "AL", positions: ["OF"], era: "Hall of Famer", eraTag: '70s', speed: 7, defense: 7, stats: { avg: .305, hr: 755, rbi: 2297, bb: 1402, so: 1383, ab: 12364 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=HA" },
            { id: 402, name: "Willie Mays", birthplace: "AL", positions: ["OF"], era: "Hall of Famer", eraTag: '50s', speed: 8, defense: 10, stats: { avg: .301, hr: 660, rbi: 1909, bb: 1468, so: 1526, ab: 10911 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=WM" },
            { id: 403, name: "Satchel Paige", birthplace: "AL", positions: ["P"], era: "Hall of Famer", eraTag: '50s', stats: { era: 3.29, so: 288, wins: 28, ip: 476, bb: 180, ha: 429 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=SP" },
            { id: 404, name: "Ozzie Smith", birthplace: "AL", positions: ["SS"], era: "Hall of Famer", eraTag: '80s', speed: 9, defense: 10, stats: { avg: .262, hr: 28, rbi: 793, bb: 1072, so: 589, ab: 9396 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=OS" },
            { id: 405, name: "Bo Jackson", birthplace: "AL", positions: ["OF"], era: "Legend", eraTag: '80s', speed: 10, defense: 8, stats: { avg: .250, hr: 141, rbi: 415, bb: 154, so: 841, ab: 2393 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=BJ" },
            { id: 406, name: "Don Sutton", birthplace: "AL", positions: ["P"], era: "Hall of Famer", eraTag: '80s', stats: { era: 3.26, so: 3574, wins: 324, ip: 5282, bb: 1343, ha: 4691 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=DS" },
            { id: 407, name: "Billy Williams", birthplace: "AL", positions: ["OF"], era: "Hall of Famer", eraTag: '70s', speed: 6, defense: 7, stats: { avg: .290, hr: 426, rbi: 1475, bb: 1045, so: 1046, ab: 9523 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=BW" },
            { id: 408, name: "Joe Sewell", birthplace: "AL", positions: ["SS", "3B"], era: "Hall of Famer", eraTag: '30s', speed: 6, defense: 8, stats: { avg: .312, hr: 49, rbi: 1055, bb: 838, so: 114, ab: 7132 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JS" },
            { id: 409, name: "Mule Suttles", birthplace: "AL", positions: ["1B"], era: "Legend", eraTag: '30s', speed: 4, defense: 5, stats: { avg: .327, hr: 237, rbi: 900, bb: 400, so: 300, ab: 4000 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=MS" },
            { id: 410, name: "Early Wynn", birthplace: "AL", positions: ["P"], era: "Hall of Famer", eraTag: '50s', stats: { era: 3.54, so: 2334, wins: 300, ip: 4566, bb: 1775, ha: 4293 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=EW" },
            { id: 411, name: "Jake Peavy", birthplace: "AL", positions: ["P"], era: "Legend", eraTag: 'modern', stats: { era: 3.63, so: 2207, wins: 152, ip: 2377, bb: 707, ha: 2162 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JP" },
            { id: 412, name: "Tim Anderson", birthplace: "AL", positions: ["SS"], era: "Active", eraTag: 'modern', speed: 8, defense: 6, stats: { avg: .282, hr: 98, rbi: 338, bb: 130, so: 800, ab: 3800 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=TA" },
            { id: 413, name: "Craig Kimbrel", birthplace: "AL", positions: ["P"], era: "Active", eraTag: 'modern', stats: { era: 2.40, so: 1192, saves: 417, ip: 750, bb: 280, ha: 450 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=CK" },
            { id: 414, name: "Heinze Zimmerman", birthplace: "AL", positions: ["3B", "SS"], era: "Legend", eraTag: '30s', speed: 7, defense: 7, stats: { avg: .295, hr: 58, rbi: 796, bb: 380, so: 450, ab: 5500 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=HZ" },
            { id: 415, name: "Jimmy Rollins", birthplace: "AL", positions: ["SS"], era: "Legend", eraTag: 'modern', speed: 9, defense: 8, stats: { avg: .264, hr: 231, rbi: 936, bb: 813, so: 1264, ab: 9294 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JR" },
            { id: 417, name: "Andre Thornton", birthplace: "AL", positions: ["1B", "DH"], era: "Legend", eraTag: '80s', speed: 3, defense: 4, stats: { avg: .254, hr: 253, rbi: 895, bb: 876, so: 1314, ab: 4945 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=AT" },
            { id: 418, name: "Corey Kluber", birthplace: "AL", positions: ["P"], era: "Active", eraTag: 'modern', stats: { era: 3.44, so: 1750, wins: 116, ip: 1650, bb: 380, ha: 1450 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=CK" },
            { id: 419, name: "Josh Donaldson", birthplace: "AL", positions: ["3B"], era: "Active", eraTag: 'modern', speed: 4, defense: 7, stats: { avg: .261, hr: 279, rbi: 816, bb: 650, so: 1300, ab: 5000 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JD" },
            { id: 420, name: "Frank Lary", birthplace: "AL", positions: ["P"], era: "Legend", eraTag: '50s', stats: { era: 3.49, so: 1099, wins: 128, ip: 2162, bb: 651, ha: 2132 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=FL" },
            { id: 421, name: "Amos Otis", birthplace: "AL", positions: ["OF"], era: "Legend", eraTag: '70s', speed: 8, defense: 8, stats: { avg: .277, hr: 193, rbi: 992, bb: 854, so: 1021, ab: 7644 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=AO" },
            { id: 422, name: "Willie Horton", birthplace: "AL", positions: ["OF", "DH"], era: "Legend", eraTag: '70s', speed: 3, defense: 5, stats: { avg: .273, hr: 325, rbi: 1163, bb: 626, so: 1183, ab: 6868 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=WH" },
            { id: 423, name: "Rusty Staub", birthplace: "AL", positions: ["OF", "1B", "DH"], era: "Legend", eraTag: '70s', speed: 2, defense: 4, stats: { avg: .279, hr: 292, rbi: 1466, bb: 1255, so: 973, ab: 9720 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=RS" },
            { id: 424, name: "David Justice", birthplace: "AL", positions: ["OF"], era: "Legend", eraTag: '90s', speed: 5, defense: 6, stats: { avg: .279, hr: 305, rbi: 1017, bb: 808, so: 1195, ab: 5576 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=DJ" },
            { id: 425, name: "Adam Wainwright", birthplace: "AL", positions: ["P"], era: "Active", eraTag: 'modern', stats: { era: 3.53, so: 2230, wins: 200, ip: 2668, bb: 720, ha: 2550 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=AW" },
            { id: 426, name: "Frank House", birthplace: "AL", positions: ["C"], era: "Legend", eraTag: '50s', speed: 4, defense: 7, stats: { avg: .248, hr: 58, rbi: 312, bb: 184, so: 351, ab: 2212 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=FH" },
            { id: 427, name: "Bruce Benedict", birthplace: "AL", positions: ["C"], era: "Legend", eraTag: '80s', speed: 3, defense: 8, stats: { avg: .242, hr: 18, rbi: 260, bb: 239, so: 219, ab: 2367 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=BB" },
            { id: 428, name: "Del Pratt", birthplace: "AL", positions: ["2B", "3B"], era: "Legend", eraTag: '30s', speed: 7, defense: 7, stats: { avg: .292, hr: 43, rbi: 979, bb: 513, so: 360, ab: 6826 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=DP" },
            { id: 429, name: "Frank Bolling", birthplace: "AL", positions: ["2B"], era: "Legend", eraTag: '50s', speed: 5, defense: 9, stats: { avg: .254, hr: 106, rbi: 556, bb: 462, so: 558, ab: 5562 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=FB" },
            { id: 501, name: "Willie McCovey", birthplace: "AL", positions: ["1B"], era: "Hall of Famer", eraTag: '70s', speed: 3, defense: 4, stats: { avg: .270, hr: 521, rbi: 1555, bb: 1345, so: 1550, ab: 8197 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=WM" },
            { id: 502, name: "Luke Sewell", birthplace: "AL", positions: ["C"], era: "Legend", eraTag: '30s', speed: 4, defense: 8, stats: { avg: .259, hr: 13, rbi: 436, bb: 199, so: 273, ab: 3608 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=LS" },
            { id: 503, name: "Jimmy Key", birthplace: "AL", positions: ["P"], era: "Legend", eraTag: '90s', stats: { era: 3.51, so: 1563, wins: 186, ip: 3119.2, bb: 897, ha: 3200 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JK" },
            { id: 504, name: "David Robertson", birthplace: "AL", positions: ["P"], era: "Active", eraTag: 'modern', stats: { era: 2.90, so: 1030, saves: 176, ip: 796.2, bb: 351, ha: 600 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=DR" },
            { id: 505, name: "Mike Dunn", birthplace: "AL", positions: ["P"], era: "Legend", eraTag: 'modern', stats: { era: 3.59, so: 477, wins: 28, ip: 461.1, bb: 233, ha: 420 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=MD" },
            { id: 506, name: "Joe Beckwith", birthplace: "AL", positions: ["P"], era: "Legend", eraTag: '80s', stats: { era: 3.54, so: 222, wins: 18, ip: 358.1, bb: 149, ha: 340 }, portrait: "https://placehold.co/100x100/1f2937/ffffff?text=JB" }
        ];

        const stadiums = [
            { name: "Hiram Bithorn Stadium", homeOf: "PR", factors: { hr: 0.9, triple: 1.0, double: 1.0, single: 1.0 }, thumbnail: "https://placehold.co/300x200/1f2937/ffffff?text=Hiram+Bithorn", dimensions: { lf: '325', cf: '404', rf: '325' } },
            { name: "Truist Park", homeOf: "AL", factors: { hr: 1.1, triple: 0.9, double: 1.0, single: 1.0 }, thumbnail: "https://placehold.co/300x200/1f2937/ffffff?text=Truist+Park", dimensions: { lf: '335', cf: '400', rf: '325' } },
        ];

        // --- GAME STATE ---
        let gameState = {
            currentScreen: 'team-1-builder-screen',
            teams: {
                1: { name: "PR", roster: {}, battingOrder: [] },
                2: { name: "AL", roster: {}, battingOrder: [] },
            },
            selectedStadium: null,
            gameSim: null,
        };

        // --- UI ELEMENTS ---
        const screens = document.querySelectorAll('.screen');
        const modal = document.getElementById('player-modal');
        let modalContext = {}; // { teamId, position }

        // --- UI LOGIC ---
        function navigateTo(screenId) {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            gameState.currentScreen = screenId;
        }

        function initializeTeamBuilder(teamId) {
            const container = document.getElementById(`team-${teamId}-builder`);
            const positions = ["C", "1B", "2B", "3B", "SS", "LF", "CF", "RF", "DH"];
            const pitcherRoles = { "SP": "Starter", "MR": "Reliever", "CL": "Closer" };

            let builderHTML = `<h3 class="text-xl font-bold mb-2 text-teal-300">Position Players</h3><div class="grid grid-cols-3 gap-2 mb-4">`;
            positions.forEach(pos => {
                builderHTML += `<div id="pos-${teamId}-${pos}" class="player-slot bg-gray-700 rounded p-2 text-center h-28 flex flex-col justify-center items-center" data-team-id="${teamId}" data-position="${pos}">
                    <span class="font-bold text-lg">${pos}</span>
                    <button class="add-player-btn mt-2 bg-teal-600 px-3 py-1 rounded text-sm hover:bg-teal-500">+</button>
                </div>`;
            });
            builderHTML += `</div>`;
            builderHTML += `<h3 class="text-xl font-bold mb-2 text-teal-300">Pitching Staff</h3><div class="grid grid-cols-3 gap-2 mb-4">`;
            Object.entries(pitcherRoles).forEach(([role, title]) => {
                 builderHTML += `<div id="pos-${teamId}-${role}" class="player-slot bg-gray-700 rounded p-2 text-center h-28 flex flex-col justify-center items-center" data-team-id="${teamId}" data-position="${role}">
                    <span class="font-bold text-lg">${title}</span>
                    <button class="add-player-btn mt-2 bg-teal-600 px-3 py-1 rounded text-sm hover:bg-teal-500">+</button>
                </div>`;
            });
            builderHTML += `</div>`;
            builderHTML += `
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xl font-bold text-teal-300">Batting Order</h3>
                    <button id="ai-lineup-btn-${teamId}" class="bg-indigo-500 text-white font-bold py-1 px-2 rounded-lg shadow-lg transition-transform hover:scale-105 uppercase text-xs">Generate AI Lineup</button>
                </div>
            `;
            builderHTML += `<div id="batting-order-${teamId}" class="drop-zone bg-gray-900 p-2 rounded space-y-1 min-h-[50px]"></div>`;
            container.innerHTML = builderHTML;
        }
        
        function openPlayerModal(teamId, position) {
            modalContext = { teamId, position };
            document.getElementById('modal-title').textContent = `Select ${position}`;
            
            const eras = ["All", "Active", "Hall of Famer", "Legend"];
            const eraFilterContainer = document.getElementById('era-filter');
            eraFilterContainer.innerHTML = eras.map(era => `
                <label class="flex items-center space-x-2">
                    <input type="radio" name="era" value="${era}" class="form-radio bg-gray-900" ${era === 'All' ? 'checked' : ''}>
                    <span>${era}</span>
                </label>
            `).join('');
            
            document.getElementById('player-search').value = '';
            populateModalList();
            modal.classList.remove('hidden');
            document.getElementById('modal-player-list').scrollTop = 0;
        }

        function populateModalList() {
            const listContainer = document.getElementById('modal-player-list');
            const search = document.getElementById('player-search').value.toLowerCase();
            const selectedEra = document.querySelector('input[name="era"]:checked').value;
            const { teamId, position } = modalContext;
            
            const requiredBirthplace = teamId == 1 ? 'PR' : 'AL';

            const isPitcherRole = ["SP", "MR", "CL"].includes(position);
            const otherTeamId = teamId == 1 ? 2 : 1;
            const otherTeamIds = new Set(Object.values(gameState.teams[otherTeamId].roster).map(p => p.id));
            const sameTeamRoster = gameState.teams[teamId].roster;

            let filteredPlayers = players.filter(p => {
                if (p.birthplace !== requiredBirthplace) return false;
                if (otherTeamIds.has(p.id)) return false;

                const isSelectedOnSameTeam = Object.values(sameTeamRoster).some(player => player.id === p.id);
                if (isSelectedOnSameTeam) return false;

                const matchesSearch = p.name.toLowerCase().includes(search);
                const matchesEra = selectedEra === 'All' || p.era === selectedEra;
                
                let matchesPosition = false;
                const outfieldPositions = ["LF", "CF", "RF"];
                if (isPitcherRole) {
                    matchesPosition = p.positions.includes("P");
                } else if (outfieldPositions.includes(position)) {
                    matchesPosition = p.positions.includes("OF");
                } else {
                    matchesPosition = p.positions.includes(position);
                }
                
                return matchesSearch && matchesEra && matchesPosition;
            });

            if (filteredPlayers.length === 0) {
                listContainer.innerHTML = `<p class="text-gray-400 text-center">No available players match the criteria.</p>`;
                return;
            }

            listContainer.innerHTML = filteredPlayers.map(p => {
                const stats = (p.positions.includes('P') && !p.twoWay) || (p.twoWay && isPitcherRole)
                    ? `W: ${p.stats.wins || 0}, ERA: ${p.stats.era || 0}, SO: ${p.stats.so_p || p.stats.so || 0}`
                    : `AVG: ${p.stats.avg || 0}, HR: ${p.stats.hr || 0}, RBI: ${p.stats.rbi || 0}`;
                return `
                    <div class="player-card flex items-center justify-between p-2 rounded hover:bg-gray-700 cursor-pointer transition duration-150" data-player-id="${p.id}">
                        <div class="flex items-center">
                            <img src="${p.portrait}" alt="${p.name}" class="w-12 h-12 rounded-full mr-4" onerror="this.onerror=null;this.src='https://placehold.co/100x100/1f2937/ffffff?text=ERR';">
                            <div>
                                <p class="font-bold text-lg">${p.name}</p>
                                <p class="text-sm text-gray-400">${stats}</p>
                            </div>
                        </div>
                        <span class="text-sm font-semibold text-teal-400">${p.era}</span>
                    </div>
                `;
            }).join('');
        }

        function selectPlayer(playerId) {
            const player = players.find(p => p.id === playerId);
            const { teamId, position } = modalContext;
            addPlayerToSlot(teamId, position, player);
            modal.classList.add('hidden');
        }
        
        function addPlayerToSlot(teamId, position, player) {
            gameState.teams[teamId].roster[position] = player;
            
            const slot = document.getElementById(`pos-${teamId}-${position}`);
            slot.innerHTML = `
                <img src="${player.portrait}" alt="${player.name}" class="w-12 h-12 rounded-full mb-1" onerror="this.onerror=null;this.src='https://placehold.co/100x100/1f2937/ffffff?text=ERR';">
                <p class="font-bold text-sm truncate">${player.name}</p>
                <button class="remove-player-btn text-red-500 text-xs hover:text-red-400">REMOVE</button>
            `;
            
            if (!["SP", "MR", "CL"].includes(position)) {
                 addPlayerToBattingOrder(teamId, player);
            }
            checkTeamReady(teamId);
        }

        function removePlayer(teamId, position) {
            const playerToRemove = gameState.teams[teamId].roster[position];
            if (!playerToRemove) return;

            delete gameState.teams[teamId].roster[position];
            
            const slot = document.getElementById(`pos-${teamId}-${position}`);
            const pitcherRoles = { "SP": "Starter", "MR": "Reliever", "CL": "Closer" };
            const positionTitle = pitcherRoles[position] || position;
            slot.innerHTML = `<span class="font-bold text-lg">${positionTitle}</span>
                                  <button class="add-player-btn mt-2 bg-teal-600 px-3 py-1 rounded text-sm hover:bg-teal-500">+</button>`;

            const battingOrderContainer = document.getElementById(`batting-order-${teamId}`);
            const playerCard = battingOrderContainer.querySelector(`[data-player-id="${playerToRemove.id}"]`);
            if(playerCard) playerCard.remove();
            
            updateBattingOrder(teamId);
        }
        
        function addPlayerToBattingOrder(teamId, player) {
            const battingOrderContainer = document.getElementById(`batting-order-${teamId}`);
            const playerCard = document.createElement('div');
            playerCard.className = 'draggable bg-gray-700 p-2 rounded flex items-center justify-between';
            playerCard.draggable = true;
            playerCard.dataset.playerId = player.id;
            playerCard.innerHTML = `
                <span class="font-bold">${player.name}</span>
                <span class="text-gray-400">${player.positions[0]}</span>
            `;
            battingOrderContainer.appendChild(playerCard);
            updateBattingOrder(teamId);
        }
        
        function updateBattingOrder(teamId) {
            const container = document.getElementById(`batting-order-${teamId}`);
            const orderedIds = Array.from(container.children).map(child => parseInt(child.dataset.playerId));
            gameState.teams[teamId].battingOrder = orderedIds;
            checkTeamReady(teamId);
        }
        
        function checkTeamReady(teamId) {
            const roster = gameState.teams[teamId].roster;
            const positionPlayers = Object.keys(roster).filter(pos => !["SP", "MR", "CL"].includes(pos));
            const pitchers = Object.keys(roster).filter(pos => ["SP", "MR", "CL"].includes(pos));
            
            const teamReady = positionPlayers.length === 9 && pitchers.length === 3 && gameState.teams[teamId].battingOrder.length === 9;
            
            if (teamId == 1) {
                document.getElementById('to-team-2-builder-btn').disabled = !teamReady;
            } else {
                document.getElementById('to-stadium-select-btn').disabled = !teamReady;
            }
        }

        function initializeStadiums() {
            const list = document.getElementById('stadium-list');
            list.innerHTML = stadiums.map(s => `
                <div class="stadium-card bg-gray-700 p-4 rounded-lg shadow-lg cursor-pointer border-2 border-gray-700 hover:border-teal-400 transition" data-stadium-name="${s.name}">
                    <h3 class="text-2xl font-bold text-center mb-4 col-span-2">${s.name}</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <img src="${s.thumbnail || 'https://placehold.co/300x200/1f2937/ffffff?text=Stadium'}" alt="${s.name}" class="w-full h-40 object-cover rounded-md">
                        </div>
                        <div class="text-sm">
                            <p>LF: ${s.dimensions.lf}' | CF: ${s.dimensions.cf}' | RF: ${s.dimensions.rf}'</p>
                            <div class="mt-4 pt-2 border-t border-gray-600">
                                <p>HR Factor: ${s.factors.hr}</p>
                                <p>Triple Factor: ${s.factors.triple}</p>
                                <p>Double Factor: ${s.factors.double}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        const commentary = {
            strikeout: [ "{batter} is caught looking, a beautiful pitch from {pitcher}!", "Swung on and missed! {pitcher} gets the strikeout!", "{pitcher} blows a fastball by {batter} for the K!", "Down on strikes! {batter} couldn't catch up to that one.", "A nasty slider from {pitcher} buckles the knees of {batter}. Strike three!", ],
            walk: [ "{pitcher} loses {batter} on a full count. That's a walk.", "Ball four, and {batter} will take his base.", "{batter} shows great patience at the plate and draws the walk.", ],
            single: [ "{batter} ropes a single into left field!", "A sharp grounder finds its way through the infield for a base hit.", "{batter} bloops one into shallow center for a single.", ],
            double: [ "{batter} smokes one into the gap! That'll be a stand-up double.", "A line drive down the right-field line, {batter} cruises into second.", "He hits it high and deep to center... it's off the wall! A double for {batter}.", ],
            triple: [ "{batter} drives one into deep right-center! He's digging for three... and he's in there! A triple!", "That ball is rattling around in the corner! {batter} is flying around the bases for a triple!", ],
            homerun: [ "That ball is hit deep to left field... way back... GONE! A home run for {batter}!", "High fly ball to right... forget about it! {batter} circles the bases!", "There it goes! A no-doubter for {batter}!", ],
            out: [ "{batter} hits a routine grounder to second, easy play for the out.", "Pops it up into foul territory... and the catcher makes the play.", "A sharp liner, but right at the shortstop for the out.", ],
            double_play: [ "Ground ball to short... they turn two! A 6-4-3 double play to end the threat!", "A tailor-made double play ball, and they execute it perfectly!", ],
            error: [ "A routine grounder, but it's bobbled! An ERROR allows {batter} to reach safely!", "The throw is wide! {batter} is safe on the error!", ],
        };

        function getCommentary(event, context) {
            const options = commentary[event];
            let text = options[Math.floor(Math.random() * options.length)];
            for (const key in context) {
                text = text.replace(`{${key}}`, context[key]);
            }
            return text;
        }

        class GameSimulation {
            constructor(team1, team2, stadium) {
                this.teams = { away: this.prepareTeam(team1), home: this.prepareTeam(team2) };
                this.stadium = stadium;
                this.log = [];
                this.events = [];
                this.score = { away: 0, home: 0 };
                this.lineScore = { away: [], home: [] };
                this.inning = 1;
                this.topOfInning = true;
                this.outs = 0;
                this.bases = [null, null, null];
                this.currentBatterIndex = { away: 0, home: 0 };
                this.isGameOver = false;
                this.stats = { players: {} };
                this.initPlayerStats();
                this.leagueAveragesByEra = {
                    '30s': { bbRate: 0.09, soRate: 0.08, hrRate: 0.015, babip: 0.290 },
                    '50s': { bbRate: 0.09, soRate: 0.11, hrRate: 0.025, babip: 0.280 },
                    '70s': { bbRate: 0.08, soRate: 0.13, hrRate: 0.020, babip: 0.280 },
                    '80s': { bbRate: 0.08, soRate: 0.14, hrRate: 0.020, babip: 0.290 },
                    '90s': { bbRate: 0.09, soRate: 0.16, hrRate: 0.030, babip: 0.295 },
                    'modern': { bbRate: 0.085, soRate: 0.23, hrRate: 0.035, babip: 0.300 },
                };
            }
            prepareTeam(teamData) {
                const team = {
                    name: teamData.name,
                    battingOrder: teamData.battingOrder.map(id => players.find(p => p.id === id)),
                    pitchers: {
                        sp: { ...teamData.roster.SP, pitchCount: 0, stamina: 95, role: 'SP' },
                        mr: { ...teamData.roster.MR, pitchCount: 0, stamina: 40, role: 'MR' },
                        cl: { ...teamData.roster.CL, pitchCount: 0, stamina: 25, role: 'CL' },
                    },
                    bullpen: ['mr', 'cl'],
                    currentPitcher: null
                };
                team.currentPitcher = team.pitchers.sp;
                return team;
            }
            initPlayerStats() {
                players.forEach(p => {
                    this.stats.players[p.id] = {
                        ab: 0, r: 0, h: 0, rbi: 0, bb: 0, so: 0, '2b': 0, '3b': 0, hr: 0,
                        ip: 0, h_a: 0, r_a: 0, er_a: 0, bb_a: 0, so_p: 0, pitchCount: 0,
                        wins: 0, saves: 0, mvpScore: 0,
                    };
                });
            }
            getLeverage() {
                const scoreDifference = Math.abs(this.score.away - this.score.home);
                const runnersOnBase = this.bases.filter(r => r !== null).length;
                let leverage = 1.0;
                if (this.inning >= 7) leverage *= 1.5;
                if (scoreDifference <= 1) leverage *= 2.0;
                if (runnersOnBase >= 2) leverage *= 1.5;
                return leverage;
            }
            updateMvpScore(playerId, value) { if (this.stats.players[playerId]) { this.stats.players[playerId].mvpScore += value; } }
            stat(playerId, stat, value = 1) { this.stats.players[playerId][stat] += value; }
            addLog(message) { this.log.push(message); }
            addEvent(eventData) { this.events.push(eventData); }
            checkPitchingChange() {
                const teamKey = this.topOfInning ? 'home' : 'away';
                const team = this.teams[teamKey];
                const pitcher = team.currentPitcher;
                const scoreDiff = this.score[teamKey] - this.score[this.topOfInning ? 'away' : 'home'];
                const isTired = pitcher.pitchCount >= pitcher.stamina;
                const isSaveSituation = this.inning >= 8 && !this.topOfInning && scoreDiff > 0 && scoreDiff <= 3;
                let nextPitcherRole = null;
                if (isSaveSituation && team.bullpen.includes('cl') && pitcher.role !== 'CL') { nextPitcherRole = 'cl'; } 
                else if (isTired && team.bullpen.length > 0) { nextPitcherRole = team.bullpen[0]; }
                if (nextPitcherRole) {
                    const newPitcher = team.pitchers[nextPitcherRole];
                    team.currentPitcher = newPitcher;
                    team.bullpen = team.bullpen.filter(p => p !== nextPitcherRole);
                    this.addLog(`--- PITCHING CHANGE: ${newPitcher.name} is now pitching for ${team.name}. ---`);
                }
            }
            simulatePlay() {
                if (this.isGameOver) return;
                this.checkPitchingChange();
                const currentTeamKey = this.topOfInning ? 'away' : 'home';
                const opposingTeamKey = this.topOfInning ? 'home' : 'away';
                const batter = this.teams[currentTeamKey].battingOrder[this.currentBatterIndex[currentTeamKey]];
                const pitcher = this.teams[opposingTeamKey].currentPitcher;
                const leagueAvg = this.leagueAveragesByEra[batter.eraTag] || this.leagueAveragesByEra['modern'];
                const leverage = this.getLeverage();
                this.addLog(`--- ${this.topOfInning ? 'Top' : 'Bottom'} of the ${this.inning}, ${this.outs} out(s) ---`);
                this.addLog(`${batter.name} steps up, facing ${pitcher.name}.`);
                const pitches = Math.floor(Math.random() * 4) + 3;
                pitcher.pitchCount += pitches;
                this.stat(pitcher.id, 'pitchCount', pitches);
                this.stat(batter.id, 'ab');
                const batterBBRate = (batter.stats.bb) / (batter.stats.ab + batter.stats.bb);
                const batterSORate = (batter.stats.so) / (batter.stats.ab + batter.stats.bb);
                const pitcherBBRate = (pitcher.stats.bb_p || pitcher.stats.bb) / ((pitcher.stats.ip * 3) || 1);
                const pitcherSORate = (pitcher.stats.so_p || pitcher.stats.so) / ((pitcher.stats.ip * 3) || 1);
                const finalBBRate = (batterBBRate / leagueAvg.bbRate) * (pitcherBBRate / leagueAvg.bbRate) * leagueAvg.bbRate;
                const finalSORate = (batterSORate / leagueAvg.soRate) * (pitcherSORate / leagueAvg.soRate) * leagueAvg.soRate;
                const roll = Math.random();
                if (roll < finalBBRate) {
                    this.addLog(getCommentary('walk', { batter: batter.name, pitcher: pitcher.name }));
                    this.stat(batter.id, 'bb'); this.stat(pitcher.id, 'bb_a');
                    this.updateMvpScore(batter.id, 0.3 * leverage); this.updateMvpScore(pitcher.id, -0.3 * leverage);
                    this.advanceRunners(batter, 1, true, leverage);
                } else if (roll < finalBBRate + finalSORate) {
                    this.addLog(getCommentary('strikeout', { batter: batter.name, pitcher: pitcher.name }));
                    this.stat(batter.id, 'so'); this.stat(pitcher.id, 'so_p');
                    this.updateMvpScore(batter.id, -0.35 * leverage); this.updateMvpScore(pitcher.id, 0.35 * leverage);
                    this.addOuts(1);
                } else {
                    this.handleBallInPlay(batter, pitcher, leagueAvg, leverage);
                }
                this.currentBatterIndex[currentTeamKey] = (this.currentBatterIndex[currentTeamKey] + 1) % 9;
                if (this.outs >= 3) { this.endOfInningHalf(); }
            }
            handleBallInPlay(batter, pitcher, leagueAvg, leverage) {
                const batterHRRate = batter.stats.hr / (batter.stats.ab + batter.stats.bb);
                const pitcherHRRate = ((pitcher.stats.ha_p || pitcher.stats.ha) / ((pitcher.stats.ip * 3) || 1)) * 0.12;
                const finalHRRate = (batterHRRate / leagueAvg.hrRate) * (pitcherHRRate / leagueAvg.hrRate) * leagueAvg.hrRate * this.stadium.factors.hr;
                if (Math.random() < finalHRRate) {
                    this.addLog(getCommentary('homerun', { batter: batter.name }));
                    this.stat(batter.id, 'h'); this.stat(batter.id, 'hr'); this.stat(pitcher.id, 'h_a');
                    const runsBefore = this.score[this.topOfInning ? 'away' : 'home'];
                    this.advanceRunners(batter, 4, false, leverage);
                    const rbi = this.score[this.topOfInning ? 'away' : 'home'] - runsBefore;
                    const mvpPoints = (1.5 + rbi) * leverage;
                    this.updateMvpScore(batter.id, mvpPoints); this.updateMvpScore(pitcher.id, -mvpPoints);
                    this.addEvent({ inning: this.inning, batter: batter.name, result: 'HR', rbi: rbi });
                    return;
                }
                const batterBABIP = (batter.stats.avg - (batter.stats.hr / batter.stats.ab)) * 1.1;
                const finalBABIP = (batterBABIP / leagueAvg.babip) * leagueAvg.babip;
                if (Math.random() < finalBABIP) {
                    const hitRoll = Math.random();
                    if (hitRoll < 0.7) { this.addLog(getCommentary('single', { batter: batter.name })); this.updateMvpScore(batter.id, 0.5 * leverage); this.advanceRunners(batter, 1, false, leverage); } 
                    else if (hitRoll < 0.95) { this.addLog(getCommentary('double', { batter: batter.name })); this.stat(batter.id, '2b'); this.updateMvpScore(batter.id, 0.8 * leverage); this.advanceRunners(batter, 2, false, leverage); } 
                    else { this.addLog(getCommentary('triple', { batter: batter.name })); this.stat(batter.id, '3b'); this.updateMvpScore(batter.id, 1.2 * leverage); this.advanceRunners(batter, 3, false, leverage); }
                    this.stat(batter.id, 'h'); this.stat(pitcher.id, 'h_a');
                } else {
                    if (this.bases[0] && this.outs < 2 && Math.random() < 0.5) { this.addLog(getCommentary('double_play', {})); this.updateMvpScore(pitcher.id, 0.8 * leverage); this.addOuts(2); this.bases[0] = null; } 
                    else { this.addLog(getCommentary('out', { batter: batter.name })); this.updateMvpScore(pitcher.id, 0.3 * leverage); this.addOuts(1); }
                }
            }
            addOuts(numOuts) {
                const pitcher = this.teams[this.topOfInning ? 'home' : 'away'].currentPitcher;
                this.outs += numOuts;
                this.stat(pitcher.id, 'ip', numOuts / 3);
            }
            advanceRunners(batter, bases, isWalk = false, leverage) {
                let runsScored = 0;
                let newBases = [null, null, null];
                const runners = [{ runner: this.bases[2], start: 2 }, { runner: this.bases[1], start: 1 }, { runner: this.bases[0], start: 0 }, { runner: batter, start: -1 }].filter(r => r.runner);
                runners.sort((a, b) => b.start - a.start);
                for (const { runner, start } of runners) {
                    let end = start + bases;
                    if (isWalk) { const isForced = runners.some(r => r.start === start - 1); if (start === -1 || isForced) end = start + 1; else end = start; }
                    if (end >= 3) { runsScored++; this.stat(runner.id, 'r'); } 
                    else { if (!newBases[end]) newBases[end] = runner; else { newBases[end + 1] = newBases[end]; newBases[end] = runner; } }
                }
                this.bases = newBases;
                if (runsScored > 0) {
                    const teamKey = this.topOfInning ? 'away' : 'home';
                    this.score[teamKey] += runsScored;
                    this.stat(batter.id, 'rbi', runsScored);
                    this.updateMvpScore(batter.id, (runsScored * 0.5) * leverage);
                    const pitcher = this.teams[this.topOfInning ? 'home' : 'away'].currentPitcher;
                    this.stat(pitcher.id, 'r_a', runsScored); this.stat(pitcher.id, 'er_a', runsScored);
                    this.addLog(`${runsScored} run(s) score.`);
                }
            }
            endOfInningHalf() {
                const teamKey = this.topOfInning ? 'away' : 'home';
                const runsThisInning = this.score[teamKey] - (this.lineScore[teamKey].reduce((a, b) => a + b, 0) || 0);
                this.lineScore[teamKey].push(runsThisInning);
                this.outs = 0;
                this.bases = [null, null, null];
                this.addLog(`------ End of ${this.topOfInning ? 'Top' : 'Bottom'} ${this.inning} | Score: ${this.teams.away.name} ${this.score.away} - ${this.teams.home.name} ${this.score.home} ------`);
                if (this.inning >= 9 && ((!this.topOfInning && this.score.home > this.score.away) || (!this.topOfInning && this.score.home !== this.score.away))) { return this.finalizeGame(); }
                if (this.topOfInning) { this.topOfInning = false; } 
                else { this.topOfInning = true; this.inning++; }
            }
            finalizeGame() {
                if (this.isGameOver) return;
                this.isGameOver = true;
                this.addLog("GAME OVER!");
                const winningTeamKey = this.score.away > this.score.home ? 'away' : 'home';
                const losingTeamKey = winningTeamKey === 'away' ? 'home' : 'away';
                const winningPitcher = this.teams[winningTeamKey].currentPitcher;
                this.stat(winningPitcher.id, 'wins');
                this.updateMvpScore(winningPitcher.id, 5);
                if (this.teams[winningTeamKey].currentPitcher.role === 'CL' && (this.score[winningTeamKey] - this.score[losingTeamKey]) <=3) { this.stat(this.teams[winningTeamKey].currentPitcher.id, 'saves'); }
                document.getElementById('to-recap-btn').classList.remove('hidden');
            }
            async generateGameSummary() {
                const winningTeamKey = this.score.away > this.score.home ? 'away' : 'home';
                const losingTeamKey = winningTeamKey === 'away' ? 'home' : 'away';
                
                const winningTeam = this.teams[winningTeamKey];
                const losingTeam = this.teams[losingTeamKey];
                
                const finalScore = `${this.teams.away.name} ${this.score.away} - ${this.teams.home.name} ${this.score.home}`;
                const mvp = getMvp(this);
                const mvpStats = this.stats.players[mvp.id];

                const intros = [
                    `What a showdown at ${this.stadium.name}!`,
                    `That's all she wrote from ${this.stadium.name}, where`,
                    `Fans at ${this.stadium.name} won't soon forget this one!`,
                    `It was a classic battle at ${this.stadium.name} today, and when the dust settled,`
                ];
                const intro = intros[Math.floor(Math.random() * intros.length)];

                let joke = '';
                let prompt = '';

                if (winningTeam.name === 'PR') { // PR Wins, AL (Braxton) loses
                    const fallbackJokes = [
                        `Looks like Coach Braxton's lineup had more holes than Swiss cheese! Wait, I thought Alabama was supposed to be superior to our small island, brah! Guess they couldn't handle the heat from the Boricuas!`,
                        `Braxton must've been managing with his eyes closed! That lineup was a swing and a miss from the start. The boys from PR came to play, and Alabama just couldn't catch up. ¡Wepa!`,
                        `Did Coach Braxton forget this was baseball and not football? Because his team got absolutely sacked today. PR's victory was sweeter than a piragua on a hot day!`
                    ];
                    joke = fallbackJokes[Math.floor(Math.random() * fallbackJokes.length)];
                    prompt = "Generate a short, funny, trash-talking baseball-themed joke from the perspective of a winning Puerto Rican team roasting the losing Alabama coach, Braxton.";

                } else { // AL Wins, PR (Edwin) loses
                    const fallbackJokes = [
                        `Coach Edwin must've thought he was managing a game of dominoes with those moves. That last pitching change was a real head-scratcher, leaving his pitcher out there to get shelled. Sweet Home Alabama, indeed!`,
                        `Tough day at the office for Coach Edwin. His team's bats were quieter than a library during finals week. Looks like the heart of Dixie beats stronger than the heart of the Caribbean today!`,
                        `Did PR's bats get lost in the Bermuda Triangle on the way to the stadium? Coach Edwin's strategy just didn't have enough 'Bama in it to compete with Braxton's powerhouse lineup.`
                    ];
                    joke = fallbackJokes[Math.floor(Math.random() * fallbackJokes.length)];
                    prompt = "Generate a short, funny, trash-talking baseball-themed joke from the perspective of a winning Alabama team roasting the losing Puerto Rican coach, Edwin.";
                }

                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // API key will be provided by the environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const generatedText = result.candidates[0].content.parts[0].text;
                        if (generatedText) {
                            joke = generatedText.replace(/\"/g, ""); // Clean up quotes
                        }
                    }
                } catch (error) {
                    console.error("AI Joke generation failed, using fallback.", error);
                    // Fallback joke is already set
                }

                const summary = `${intro} The ${winningTeam.name} put on a clinic, taking down ${losingTeam.name} with a final score of ${finalScore}. ${joke}`;

                let mvpLine = '';
                if (mvpStats.ip > 0) {
                    const ipString = `${Math.floor(mvpStats.ip)}.${Math.round((mvpStats.ip % 1) * 3)}`;
                    mvpLine = `${mvp.name} was the star of the show, pitching a gem for ${ipString} innings to grab the W.`;
                } else {
                    mvpLine = `The hero of the day was undoubtedly ${mvp.name}, who went ${mvpStats.h}-for-${mvpStats.ab} with ${mvpStats.rbi} RBI, leading the offensive explosion.`;
                }
                
                return `${summary} ${mvpLine}`;
            }
            runFullGame() {
                while(!this.isGameOver && this.log.length < 2000) { this.simulatePlay(); }
                if (!this.isGameOver) this.finalizeGame();
            }
        }
        
        function getMvp(sim) {
            let mvp = null;
            let maxMvpScore = -Infinity;
            Object.keys(sim.stats.players).forEach(playerId => {
                const pStats = sim.stats.players[playerId];
                const player = players.find(p => p.id == playerId);
                if (!player || (pStats.ab === 0 && pStats.ip === 0)) return;
                if (pStats.mvpScore > maxMvpScore) { maxMvpScore = pStats.mvpScore; mvp = player; }
            });
            return mvp;
        }

        function updateScoreboard() {
            const sim = gameState.gameSim;
            if (!sim) return;
            const inningDisplay = sim.isGameOver ? "Final" : `${sim.topOfInning ? '▲' : '▼'} ${sim.inning}`;
            document.getElementById('scoreboard').innerHTML = `<div class="flex justify-between items-center text-xl md:text-2xl font-mono bg-gray-900 p-2 rounded"><div>${sim.teams.away.name}: <span class="font-bold text-teal-400">${sim.score.away}</span></div><div class="text-center">${inningDisplay}<br>${!sim.isGameOver ? `Outs: ${sim.outs}` : ''}</div><div>${sim.teams.home.name}: <span class="font-bold text-teal-400">${sim.score.home}</span></div></div>`;
        }
        
        function updatePlayByPlay() {
            const sim = gameState.gameSim;
            if (!sim) return;
            const logContainer = document.getElementById('play-by-play');
            logContainer.innerHTML = sim.log.map(entry => `<p>${entry}</p>`).join('');
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function generateRecap() {
            const sim = gameState.gameSim;
            const mvp = getMvp(sim);
            const mvpStats = sim.stats.players[mvp.id];
            let mvpStatLine = '';
            if (mvpStats.ip > 0) {
                const ipString = `${Math.floor(mvpStats.ip)}.${Math.round((mvpStats.ip % 1) * 3)}`;
                mvpStatLine = `${ipString} IP, ${mvpStats.so_p} K, ${mvpStats.er_a} ER`;
                if (mvpStats.wins > 0) mvpStatLine += ', W';
            } else { mvpStatLine = `${mvpStats.h}-for-${mvpStats.ab}, ${mvpStats.hr} HR, ${mvpStats.rbi} RBI`; }
            document.getElementById('mvp-section').innerHTML = `<h3 class="text-3xl font-bold">Game MVP 🏆</h3><img src="${mvp.portrait}" class="w-24 h-24 rounded-full mx-auto my-2 border-4 border-teal-400 bg-gray-700 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/100x100/1f2937/ffffff?text=MVP';"><p class="text-2xl font-bold">${mvp.name}</p><p class="text-teal-400 font-semibold">${mvpStatLine}</p>`;
            document.getElementById('inning-box-score').innerHTML = generateInningBoxScore(sim);
            document.getElementById('box-score').innerHTML = `<div class="space-y-6">${generateTeamBoxScore(sim, 'away')}${generateTeamBoxScore(sim, 'home')}</div>`;
        }

        function generateInningBoxScore(sim) {
            const innings = Math.max(sim.lineScore.away.length, 9);
            let header = '<th class="p-2"></th>';
            for (let i = 1; i <= innings; i++) { header += `<th class="p-2 text-center">${i}</th>`; }
            header += '<th class="p-2 text-center font-bold">R</th><th class="p-2 text-center font-bold">H</th><th class="p-2 text-center font-bold">E</th>';
            const totalHits = (teamKey) => Array.from(sim.teams[teamKey].battingOrder).reduce((acc, p) => acc + sim.stats.players[p.id].h, 0);
            const awayRow = `<tr><td class="p-2 font-semibold">${sim.teams.away.name}</td>${sim.lineScore.away.map(r => `<td class="p-2 text-center">${r}</td>`).join('')}${'<td></td>'.repeat(innings - sim.lineScore.away.length)}<td class="p-2 text-center font-bold">${sim.score.away}</td><td class="p-2 text-center font-bold">${totalHits('away')}</td><td class="p-2 text-center font-bold">0</td></tr>`;
            const homeRow = `<tr><td class="p-2 font-semibold">${sim.teams.home.name}</td>${sim.lineScore.home.map(r => `<td class="p-2 text-center">${r}</td>`).join('')}${'<td></td>'.repeat(innings - sim.lineScore.home.length)}<td class="p-2 text-center font-bold">${sim.score.home}</td><td class="p-2 text-center font-bold">${totalHits('home')}</td><td class="p-2 text-center font-bold">0</td></tr>`;
            return `<table class="w-full text-left text-sm"><thead><tr class="border-b-2 border-gray-600">${header}</tr></thead><tbody>${awayRow}${homeRow}</tbody></table>`;
        }

        function generateTeamBoxScore(sim, teamKey) {
            const team = sim.teams[teamKey];
            let battingHtml = `<h4 class="text-2xl font-bold text-teal-300 mb-2">${team.name} Batting</h4><table class="w-full text-left text-sm"><thead class="border-b-2 border-gray-600"><tr><th class="p-2">Player</th><th class="p-2 text-center">AB</th><th class="p-2 text-center">R</th><th class="p-2 text-center">H</th><th class="p-2 text-center">RBI</th><th class="p-2 text-center">BB</th><th class="p-2 text-center">SO</th></tr></thead><tbody>`;
            team.battingOrder.forEach(p => { const s = sim.stats.players[p.id]; battingHtml += `<tr class="border-b border-gray-700"><td class="p-2 font-semibold">${p.name}</td><td class="p-2 text-center">${s.ab}</td><td class="p-2 text-center">${s.r}</td><td class="p-2 text-center">${s.h}</td><td class="p-2 text-center">${s.rbi}</td><td class="p-2 text-center">${s.bb}</td><td class="p-2 text-center">${s.so}</td></tr>`; });
            battingHtml += `</tbody></table>`;
            let pitchingHtml = `<h4 class="text-2xl font-bold text-teal-300 mt-6 mb-2">${team.name} Pitching</h4><table class="w-full text-left text-sm"><thead class="border-b-2 border-gray-600"><tr><th class="p-2">Player</th><th class="p-2 text-center">IP</th><th class="p-2 text-center">H</th><th class="p-2 text-center">ER</th><th class="p-2 text-center">BB</th><th class="p-2 text-center">SO</th></tr></thead><tbody>`;
            Object.values(team.pitchers).forEach(p => { const s = sim.stats.players[p.id]; if (s.ip > 0) { const ipString = `${Math.floor(s.ip)}.${Math.round((s.ip % 1) * 3)}`; pitchingHtml += `<tr class="border-b border-gray-700"><td class="p-2 font-semibold">${p.name}</td><td class="p-2 text-center">${ipString}</td><td class="p-2 text-center">${s.h_a}</td><td class="p-2 text-center">${s.er_a}</td><td class="p-2 text-center">${s.bb_a}</td><td class="p-2 text-center">${s.so_p}</td></tr>`; } });
            pitchingHtml += `</tbody></table>`;
            return battingHtml + pitchingHtml + generateHitBreakdown(sim, teamKey);
        }
        
        function generateHitBreakdown(sim, teamKey) {
            let breakdownHtml = `<div class="mt-4 space-y-1">
                                    <h4 class="text-xl font-bold text-teal-300 mb-2">Hit Breakdown</h4>`;
            const hits = { '2B': [], '3B': [], HR: [], RBI: [] };
            
            sim.teams[teamKey].battingOrder.forEach(p => {
                const s = sim.stats.players[p.id];
                if (s['2b'] > 0) hits['2B'].push(`${p.name} (${s['2b']})`);
                if (s['3b'] > 0) hits['3B'].push(`${p.name} (${s['3b']})`);
                if (s.hr > 0) hits.HR.push(`${p.name} (${s.hr})`);
                if (s.rbi > 0) hits.RBI.push(`${p.name} (${s.rbi})`);
            });

            if (hits['2B'].length > 0) breakdownHtml += `<p class="text-sm"><span class="font-semibold">2B:</span> ${hits['2B'].join(', ')}</p>`;
            if (hits['3B'].length > 0) breakdownHtml += `<p class="text-sm"><span class="font-semibold">3B:</span> ${hits['3B'].join(', ')}</p>`;
            if (hits.HR.length > 0) breakdownHtml += `<p class="text-sm"><span class="font-semibold">HR:</span> ${hits.HR.join(', ')}</p>`;
            if (hits.RBI.length > 0) breakdownHtml += `<p class="text-sm"><span class="font-semibold">RBI:</span> ${hits.RBI.join(', ')}</p>`;
            
            if (Object.values(hits).every(arr => arr.length === 0)) {
                return ''; // Return nothing if there's no data to show
            }

            breakdownHtml += `</div>`;
            return breakdownHtml;
        }

        function resetGame() {
            gameState.teams = { 1: { name: "PR", roster: {}, battingOrder: [] }, 2: { name: "AL", roster: {}, battingOrder: [] }, };
            gameState.selectedStadium = null;
            gameState.gameSim = null;
            initializeTeamBuilder(1);
            initializeTeamBuilder(2);
            document.getElementById('to-game-btn').disabled = true;
            document.querySelectorAll('.stadium-card').forEach(c => c.classList.remove('selected'));
        }

        async function startNewGame() {
            const summaryContainer = document.getElementById('game-summary');
            document.getElementById('game-inning-box-score').classList.add('hidden');
            summaryContainer.innerHTML = `<h4 class="text-2xl font-bold text-teal-300 mb-2">GAME SUMMARY</h4><p>Simulating game...</p>`;
            summaryContainer.classList.remove('hidden');
            document.getElementById('to-recap-btn').classList.add('hidden');
            
            // Allow UI to update before running the full simulation
            await new Promise(resolve => setTimeout(resolve, 100));

            gameState.gameSim = new GameSimulation(gameState.teams[1], gameState.teams[2], gameState.selectedStadium);
            gameState.gameSim.runFullGame();
            updateScoreboard();
            updatePlayByPlay();
            const boxScoreContainer = document.getElementById('game-inning-box-score');
            boxScoreContainer.innerHTML = generateInningBoxScore(gameState.gameSim);
            boxScoreContainer.classList.remove('hidden');
            
            const summaryText = await gameState.gameSim.generateGameSummary();
            summaryContainer.innerHTML = `<h4 class="text-2xl font-bold text-teal-300 mb-2">GAME SUMMARY</h4><p>${summaryText}</p>`;
        }
        
        function randomizeTeam(teamId) {
            const allPositions = ["C", "1B", "2B", "3B", "SS", "LF", "CF", "RF", "DH", "SP", "MR", "CL"];
            allPositions.forEach(pos => { if (gameState.teams[teamId].roster[pos]) { removePlayer(teamId, pos); } });
            gameState.teams[teamId].roster = {};
            gameState.teams[teamId].battingOrder = [];
            document.getElementById(`batting-order-${teamId}`).innerHTML = '';
            
            const requiredBirthplace = teamId == 1 ? 'PR' : 'AL';
            const usedPlayerIds = new Set();
            const positionMap = { "C": ["C"], "1B": ["1B"], "2B": ["2B"], "3B": ["3B"], "SS": ["SS"], "LF": ["OF"], "CF": ["OF"], "RF": ["OF"], "DH": ["C", "1B", "2B", "3B", "SS", "OF", "DH"], "SP": ["P"], "MR": ["P"], "CL": ["P"] };

            allPositions.forEach(pos => {
                const eligiblePositions = positionMap[pos];
                let availablePlayers = players.filter(p => p.birthplace === requiredBirthplace && !usedPlayerIds.has(p.id) && p.positions.some(pp => eligiblePositions.includes(pp)));
                if (availablePlayers.length > 0) {
                    const randomPlayer = availablePlayers[Math.floor(Math.random() * availablePlayers.length)];
                    usedPlayerIds.add(randomPlayer.id);
                    addPlayerToSlot(teamId, pos, randomPlayer);
                }
            });
            generateAiLineup(teamId);
        }
        
        function generateAiLineup(teamId) {
            const roster = gameState.teams[teamId].roster;
            const positionPlayers = Object.keys(roster)
                .filter(pos => !["SP", "MR", "CL"].includes(pos))
                .map(pos => roster[pos]);

            if (positionPlayers.length < 9) {
                console.error("Not enough position players to generate a lineup.");
                return;
            }

            const scorePlayer = (player) => {
                const stats = player.stats;
                if (!stats.ab || stats.ab === 0) return { player, scores: { leadoff: 0, contact: 0, power: 0, overall: 0 } };
                
                const obp = (stats.h + stats.bb) / (stats.ab + stats.bb);
                const slg = ((stats.h - (stats.hr)) * 1.4 + stats.hr * 4) / stats.ab; // Simplified SLG
                const ops = obp + slg;
                const contactRate = 1 - (stats.so / stats.ab);

                return {
                    player,
                    scores: {
                        leadoff: (obp * 2) + (player.speed * 0.1),
                        contact: (contactRate * 1.5) + (stats.avg * 1.5),
                        power: (slg * 2) + (stats.hr * 0.2),
                        overall: ops
                    }
                };
            };

            let scoredPlayers = positionPlayers.map(scorePlayer);
            let lineup = new Array(9).fill(null);

            const assignPlayer = (spot, sortBy) => {
                if (scoredPlayers.length === 0) return;
                scoredPlayers.sort((a, b) => b.scores[sortBy] - a.scores[sortBy]);
                const best = scoredPlayers.shift();
                lineup[spot] = best.player;
            };

            // Place key lineup spots
            assignPlayer(0, 'leadoff');    // Leadoff: Best OBP and speed
            assignPlayer(2, 'overall');    // 3-hole: Best overall hitter
            assignPlayer(3, 'power');      // Cleanup: Best power
            assignPlayer(1, 'contact');    // 2-hole: Best contact hitter
            assignPlayer(4, 'power');      // 5-hole: Second best power
            
            // Fill the rest based on overall score
            scoredPlayers.sort((a, b) => b.scores.overall - a.scores.overall);
            [5, 6, 7, 8].forEach(spot => {
                if(lineup[spot] === null && scoredPlayers.length > 0) {
                    lineup[spot] = scoredPlayers.shift().player;
                }
            });

            // Final check for any null spots (should not happen with 9 players)
            for (let i = 0; i < lineup.length; i++) {
                if (lineup[i] === null && scoredPlayers.length > 0) {
                    lineup[i] = scoredPlayers.shift().player;
                }
            }

            const battingOrderContainer = document.getElementById(`batting-order-${teamId}`);
            battingOrderContainer.innerHTML = lineup.map(player => {
                if (!player) return ''; // Handle case where a player might be null
                return `<div class="draggable bg-gray-700 p-2 rounded flex items-center justify-between" draggable="true" data-player-id="${player.id}">
                            <span class="font-bold">${player.name}</span>
                            <span class="text-gray-400">${player.positions[0]}</span>
                        </div>`;
            }).join('');

            updateBattingOrder(teamId);
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('click', (e) => {
            if (e.target.id === 'to-team-2-builder-btn') navigateTo('team-2-builder-screen');
            if (e.target.id === 'to-stadium-select-btn') navigateTo('stadium-selector-screen');
            if (e.target.id === 'to-game-btn') { navigateTo('game-simulation-screen'); startNewGame(); }
            if (e.target.id === 'to-recap-btn') { generateRecap(); navigateTo('recap-screen'); }
            if (e.target.id === 'to-home-btn') { resetGame(); navigateTo('team-1-builder-screen'); }
            if (e.target.id === 'rematch-btn') { navigateTo('game-simulation-screen'); startNewGame(); }
            if (e.target.id === 'randomize-team-1-btn') randomizeTeam(1);
            if (e.target.id === 'randomize-team-2-btn') randomizeTeam(2);
            if (e.target.id === 'ai-lineup-btn-1') generateAiLineup(1);
            if (e.target.id === 'ai-lineup-btn-2') generateAiLineup(2);
            if (e.target.classList.contains('add-player-btn')) { const slot = e.target.closest('.player-slot'); openPlayerModal(slot.dataset.teamId, slot.dataset.position); }
            if (e.target.classList.contains('remove-player-btn')) { const slot = e.target.closest('.player-slot'); removePlayer(slot.dataset.teamId, slot.dataset.position); }
            if (e.target.closest('.player-card')) { const card = e.target.closest('.player-card'); selectPlayer(parseInt(card.dataset.playerId)); }
            if (e.target.closest('.stadium-card')) { document.querySelectorAll('.stadium-card').forEach(c => c.classList.remove('selected')); const card = e.target.closest('.stadium-card'); card.classList.add('selected'); gameState.selectedStadium = stadiums.find(s => s.name === card.dataset.stadiumName); document.getElementById('to-game-btn').disabled = false; }
            if (e.target.id === 'modal-close-btn') { modal.classList.add('hidden'); }
        });

        document.getElementById('player-search').addEventListener('input', populateModalList);
        document.getElementById('era-filter').addEventListener('change', populateModalList);
        
        let draggedItem = null;
        document.getElementById('app').addEventListener('dragstart', (e) => { if (e.target.classList.contains('draggable')) { draggedItem = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); } });
        document.getElementById('app').addEventListener('dragend', (e) => { if (draggedItem) { draggedItem.classList.remove('dragging'); const teamBuilder = draggedItem.closest('.team-builder'); if (teamBuilder) { const teamId = teamBuilder.id.includes('1') ? 1 : 2; updateBattingOrder(teamId); } draggedItem = null; } });
        document.getElementById('app').addEventListener('dragover', (e) => { e.preventDefault(); const dropZone = e.target.closest('.drop-zone'); if (dropZone && draggedItem) { const afterElement = getDragAfterElement(dropZone, e.clientY); if (afterElement == null) { dropZone.appendChild(draggedItem); } else { dropZone.insertBefore(draggedItem, afterElement); } } });
        function getDragAfterElement(container, y) { const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element; }

        // --- INITIALIZATION ---
        initializeTeamBuilder(1);
        initializeTeamBuilder(2);
        initializeStadiums();
    </script>
</body>
</html>
